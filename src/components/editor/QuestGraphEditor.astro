---

---

<div
  x-show="showQuestEditor"
  class="absolute inset-0 z-50 flex flex-col font-sans bg-[var(--bg-app)]"
  style="display: none;"
  x-transition
  x-init="$watch('showQuestEditor', (val) => {
    if(val) {
        setTimeout(() => {
            window.initLiteGraph();
            const ent = config.entities[selectedEntityIdx];
            window.loadGraphData(ent?.questGraph);
        }, 100);
    }
  })"
>
  <!-- Toolbar / Header -->
  <div
    class="h-12 bg-[var(--bg-header)] border-b border-[var(--border-field)] flex items-center px-4 justify-between shrink-0 select-none shadow-md z-10"
  >
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2 text-[var(--accent-primary)]">
        <span class="text-xl">üï∏Ô∏è</span>
        <span class="font-bold tracking-widest text-xs uppercase"
          >Quest Flow</span
        >
      </div>

      <div class="w-px h-5 bg-[var(--border-light)]"></div>

      <!-- TEMPLATES DROPDOWN -->
      <div class="relative" x-data="{ open: false }">
        <button
          @click="open = !open"
          class="blender-btn"
          :class="{ 'active': open }"
        >
          <span>üìã</span>
          <span>Templates</span>
          <span class="text-[8px] ml-1 opacity-50">‚ñº</span>
        </button>

        <div
          x-show="open"
          @click.away="open = false"
          x-transition.origin.top.left
          class="absolute top-full left-0 mt-2 bg-[var(--bg-panel)] border border-[var(--border-field)] rounded-md shadow-[var(--shadow-lg)] min-w-[220px] py-1 z-[100] animate-slide-up"
        >
          <button
            @click="window.loadTemplate('empty'); open = false"
            class="w-full px-3 py-2 text-left text-sm hover:bg-[var(--accent-primary)]/20 flex items-center gap-2"
          >
            <span>üìÑ</span> Empty (Start Fresh)
          </button>
          <button
            @click="window.loadTemplate('simple_talk'); open = false"
            class="w-full px-3 py-2 text-left text-sm hover:bg-[var(--accent-primary)]/20 flex items-center gap-2"
          >
            <span>üí¨</span> Simple Talk
          </button>
          <button
            @click="window.loadTemplate('yes_no'); open = false"
            class="w-full px-3 py-2 text-left text-sm hover:bg-[var(--accent-primary)]/20 flex items-center gap-2"
          >
            <span>üîÄ</span> Yes / No Choice
          </button>
          <button
            @click="window.loadTemplate('fetch_quest'); open = false"
            class="w-full px-3 py-2 text-left text-sm hover:bg-[var(--accent-primary)]/20 flex items-center gap-2"
          >
            <span>üì¶</span> Fetch Quest
          </button>
          <button
            @click="window.loadTemplate('shop'); open = false"
            class="w-full px-3 py-2 text-left text-sm hover:bg-[var(--accent-primary)]/20 flex items-center gap-2"
          >
            <span>üõí</span> Shop / Trade
          </button>
        </div>
      </div>

      <div class="w-px h-5 bg-[var(--border-light)]"></div>

      <div
        class="flex items-center gap-2 bg-[var(--bg-input)] rounded px-3 py-1 border border-[var(--border-field)] text-[11px]"
      >
        <span class="text-[var(--text-muted)] font-medium">NPC:</span>
        <span
          class="text-[var(--accent-primary)] font-bold uppercase tracking-wide"
          x-text="config.entities[selectedEntityIdx]?.name || config.entities[selectedEntityIdx]?.asset || 'Unknown'"
        ></span>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div
        class="text-[10px] text-[var(--text-dim)] mr-4 font-medium uppercase tracking-wider"
      >
        <span class="opacity-50">Right Click to</span> Add Nodes
      </div>

      <button
        @click="closeQuestEditor()"
        class="blender-btn hover:border-red-500 hover:bg-red-500/20 text-[var(--text-muted)] hover:text-red-400"
        title="Cancel"
      >
        <span>‚úï</span>
        <span>Cancel</span>
      </button>

      <button
        @click="saveQuestGraph(window.getGraphData()); closeQuestEditor()"
        class="blender-btn bg-[var(--accent-primary)]/10 border-[var(--accent-primary)]/50 hover:bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]"
        title="Save & Close"
      >
        <span>üíæ</span>
        <span>Save</span>
      </button>
    </div>
  </div>

  <!-- Graph Container -->
  <div
    class="flex-1 relative overflow-hidden bg-[#0d0d0d]"
    id="graph-container"
  >
    <canvas id="quest-graph-canvas" class="block w-full h-full outline-none"
    ></canvas>
  </div>
</div>

<script>
  // @ts-nocheck
  import { LGraph, LGraphCanvas, LiteGraph } from "litegraph.js";
  import "litegraph.js/css/litegraph.css";

  // Register Custom Nodes
  function registerNodes() {
    LiteGraph.registered_node_types = {};
    LiteGraph.Nodes = {};

    if (LiteGraph.registered_node_types["Dialog/Start"]) return;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NODE: START
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // --- CUSTOM NODES with Premium Colors (High Contrast) ---
    // Palette: Header = Darker Accent (text is white), Body = Dark Neutral (#101010)

    function StartNode() {
      this.addOutput("‚Üí", "flow");
      this.title = "‚ñ∂ START";
      this.color = "#047857"; // Emerald 700
      this.bgcolor = "#121212";
      this.boxcolor = "#10b981"; // Bright border on select
      this.size = [140, 30];
    }
    StartNode.title = "Start";
    LiteGraph.registerNodeType("Dialog/Start", StartNode);

    function SayNode() {
      this.addInput("‚Üí", "flow");
      this.addOutput("‚Üí", "flow");
      this.properties = { text: "Hello!" };
      this.addWidget(
        "text",
        "Text",
        this.properties.text,
        (v) => (this.properties.text = v),
      );
      this.title = "üí¨ SAY";
      this.color = "#1d4ed8"; // Blue 700
      this.bgcolor = "#121212";
      this.boxcolor = "#3b82f6";
      this.size = [240, 60];
    }
    SayNode.title = "Say";
    LiteGraph.registerNodeType("Dialog/Say", SayNode);

    function ChoiceNode() {
      this.addInput("‚Üí", "flow");
      this.addOutput("Option 1", "flow");
      this.addOutput("Option 2", "flow");
      this.addOutput("Option 3", "flow");

      this.properties = {
        options: ["Yes", "No", "Maybe"],
        prompt: "Yes, I have it.",
      };

      this.addWidget(
        "text",
        "Prompt",
        this.properties.prompt,
        (v) => (this.properties.prompt = v),
      );
      // We'll mimic dynamic widgets if needed, simplistic for now
      this.addWidget("text", "‚ë†", this.properties.options[0] || "", (v) => {
        this.properties.options[0] = v;
      });
      this.addWidget("text", "‚ë°", this.properties.options[1] || "", (v) => {
        this.properties.options[1] = v;
      });
      this.addWidget("text", "‚ë¢", this.properties.options[2] || "", (v) => {
        this.properties.options[2] = v;
      });

      this.title = "üîÄ CHOICE";
      this.color = "#b45309"; // Amber 700 (Darker for white text)
      this.bgcolor = "#121212";
      this.boxcolor = "#f59e0b";
      this.size = [220, 160];
    }
    ChoiceNode.title = "Choice";
    LiteGraph.registerNodeType("Dialog/Choice", ChoiceNode);

    function CheckNode() {
      this.addInput("‚Üí", "flow");
      this.addOutput("True", "flow");
      this.addOutput("False", "flow");

      this.properties = { checkType: "Item", itemId: "key", amount: 1 };
      this.addWidget(
        "combo",
        "Check",
        this.properties.checkType,
        (v) => (this.properties.checkType = v),
        { values: ["Item", "QuestStatus", "Level"] },
      );
      this.addWidget(
        "text",
        "ID",
        this.properties.itemId,
        (v) => (this.properties.itemId = v),
      );
      this.addWidget(
        "number",
        "Amount",
        this.properties.amount,
        (v) => (this.properties.amount = v),
      );

      this.title = "‚ùì CHECK";
      this.color = "#6d28d9"; // Violet 700
      this.bgcolor = "#121212";
      this.boxcolor = "#8b5cf6";
      this.size = [200, 140];
    }
    CheckNode.title = "Check";
    LiteGraph.registerNodeType("Dialog/Check", CheckNode);

    function GiveNode() {
      this.addInput("‚Üí", "flow");
      this.addOutput("‚Üí", "flow");

      this.properties = { giveType: "Item", itemId: "coin", amount: 10 };
      this.addWidget(
        "combo",
        "Give",
        this.properties.giveType,
        (v) => (this.properties.giveType = v),
        { values: ["Item", "Experience", "Quest"] },
      );
      this.addWidget(
        "text",
        "ID",
        this.properties.itemId,
        (v) => (this.properties.itemId = v),
      );
      this.addWidget(
        "number",
        "Amount",
        this.properties.amount,
        (v) => (this.properties.amount = v),
      );

      this.title = "üéÅ GIVE";
      this.color = "#be185d"; // Pink 700
      this.bgcolor = "#121212";
      this.boxcolor = "#ec4899";
      this.size = [200, 120];
    }
    GiveNode.title = "Give";
    LiteGraph.registerNodeType("Dialog/Give", GiveNode);

    function EndNode() {
      this.addInput("‚Üí", "flow");
      this.title = "‚¨õ END";
      this.color = "#b91c1c"; // Red 700
      this.bgcolor = "#121212";
      this.boxcolor = "#ef4444";
      this.size = [120, 30];
    }
    EndNode.title = "End";
    LiteGraph.registerNodeType("Dialog/End", EndNode);
  }

  // Initialize
  registerNodes();

  let graph = null;
  let canvas = null;

  window.initLiteGraph = function () {
    if (graph) return;

    LiteGraph.NODE_TITLE_HEIGHT = 24;
    LiteGraph.NODE_SLOT_HEIGHT = 18;
    LiteGraph.NODE_TEXT_SIZE = 12;

    graph = new LGraph();
    const canvasEl = document.getElementById("quest-graph-canvas");
    if (!canvasEl) return;

    canvas = new LGraphCanvas("#quest-graph-canvas", graph);
    canvas.background_color = "#0d0d0d";
    canvas.render_connections_shadows = false;
    canvas.connections_width = 2;

    const container = document.getElementById("graph-container");
    const ro = new ResizeObserver(() => {
      if (container && canvas)
        canvas.resize(container.clientWidth, container.clientHeight);
    });
    ro.observe(container);

    graph.start();
  };

  window.loadGraphData = function (data) {
    if (!graph) window.initLiteGraph();
    graph.clear();
    if (data) {
      graph.configure(data);
    } else {
      window.loadTemplate("simple_talk");
    }
  };

  window.getGraphData = function () {
    return graph ? graph.serialize() : null;
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TEMPLATES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.loadTemplate = function (name) {
    if (!graph) window.initLiteGraph();
    graph.clear();

    const templates = {
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // EMPTY
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      empty: () => {
        const start = LiteGraph.createNode("Dialog/Start");
        start.pos = [100, 200];
        graph.add(start);
      },

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // SIMPLE TALK: Start ‚Üí Say ‚Üí Say ‚Üí End
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      simple_talk: () => {
        const start = LiteGraph.createNode("Dialog/Start");
        start.pos = [100, 150];
        graph.add(start);

        const say1 = LiteGraph.createNode("Dialog/Say");
        say1.pos = [300, 150];
        say1.properties.text = "Hello traveler!";
        graph.add(say1);

        const say2 = LiteGraph.createNode("Dialog/Say");
        say2.pos = [550, 150];
        say2.properties.text = "Safe travels!";
        graph.add(say2);

        const end = LiteGraph.createNode("Dialog/End");
        end.pos = [800, 150];
        graph.add(end);

        start.connect(0, say1, 0);
        say1.connect(0, say2, 0);
        say2.connect(0, end, 0);
      },

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // YES/NO CHOICE
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      yes_no: () => {
        const start = LiteGraph.createNode("Dialog/Start");
        start.pos = [100, 150];
        graph.add(start);

        const ask = LiteGraph.createNode("Dialog/Say");
        ask.pos = [280, 150];
        ask.properties.text = "Want to hear a secret?";
        graph.add(ask);

        const choice = LiteGraph.createNode("Dialog/Choice");
        choice.pos = [500, 130];
        choice.properties.c1 = "Yes please!";
        choice.properties.c2 = "No thanks";
        choice.outputs[0].name = "Yes please!";
        choice.outputs[1].name = "No thanks";
        graph.add(choice);

        const sayYes = LiteGraph.createNode("Dialog/Say");
        sayYes.pos = [740, 80];
        sayYes.properties.text = "The treasure is hidden under the old tree!";
        graph.add(sayYes);

        const sayNo = LiteGraph.createNode("Dialog/Say");
        sayNo.pos = [740, 220];
        sayNo.properties.text = "Suit yourself!";
        graph.add(sayNo);

        const end1 = LiteGraph.createNode("Dialog/End");
        end1.pos = [1000, 80];
        graph.add(end1);

        const end2 = LiteGraph.createNode("Dialog/End");
        end2.pos = [1000, 220];
        graph.add(end2);

        start.connect(0, ask, 0);
        ask.connect(0, choice, 0);
        choice.connect(0, sayYes, 0);
        choice.connect(1, sayNo, 0);
        sayYes.connect(0, end1, 0);
        sayNo.connect(0, end2, 0);
      },

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // FETCH QUEST: "Do you have my item?" ‚Üí Yes/No ‚Üí Check
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      fetch_quest: () => {
        // START
        const start = LiteGraph.createNode("Dialog/Start");
        start.pos = [50, 180];
        graph.add(start);

        // "Do you have my item?"
        const ask = LiteGraph.createNode("Dialog/Say");
        ask.pos = [220, 180];
        ask.properties.text = "Do you have my sword?";
        graph.add(ask);

        // CHOICE: Yes / No
        const choice = LiteGraph.createNode("Dialog/Choice");
        choice.pos = [450, 160];
        choice.properties.c1 = "Yes, I have it!";
        choice.properties.c2 = "No, sorry";
        choice.outputs[0].name = "Yes, I have it!";
        choice.outputs[1].name = "No, sorry";
        graph.add(choice);

        // CHECK: Does player actually have the sword?
        const check = LiteGraph.createNode("Dialog/Check");
        check.pos = [700, 100];
        check.properties.type = "item";
        check.properties.id = "sword";
        check.properties.amount = 1;
        graph.add(check);

        // NO branch ‚Üí "Oh too bad"
        const sayBad = LiteGraph.createNode("Dialog/Say");
        sayBad.pos = [700, 280];
        sayBad.properties.text = "Oh, too bad...";
        graph.add(sayBad);

        // CHECK YES ‚Üí "Thanks man!"
        const sayThanks = LiteGraph.createNode("Dialog/Say");
        sayThanks.pos = [940, 50];
        sayThanks.properties.text = "Thanks man!";
        graph.add(sayThanks);

        // CHECK NO ‚Üí "You don't have it!"
        const sayLiar = LiteGraph.createNode("Dialog/Say");
        sayLiar.pos = [940, 180];
        sayLiar.properties.text = "You don't have it!";
        graph.add(sayLiar);

        // GIVE money after thanks
        const give = LiteGraph.createNode("Dialog/Give");
        give.pos = [1160, 50];
        give.properties.type = "money";
        give.properties.id = "";
        give.properties.amount = 100;
        graph.add(give);

        // END nodes
        const end1 = LiteGraph.createNode("Dialog/End");
        end1.pos = [1360, 50];
        graph.add(end1);

        const end2 = LiteGraph.createNode("Dialog/End");
        end2.pos = [1160, 180];
        graph.add(end2);

        const end3 = LiteGraph.createNode("Dialog/End");
        end3.pos = [940, 280];
        graph.add(end3);

        // Connect: START ‚Üí ASK ‚Üí CHOICE
        start.connect(0, ask, 0);
        ask.connect(0, choice, 0);

        // CHOICE "Yes" ‚Üí CHECK
        choice.connect(0, check, 0);
        // CHOICE "No" ‚Üí "Oh too bad" ‚Üí END
        choice.connect(1, sayBad, 0);
        sayBad.connect(0, end3, 0);

        // CHECK ‚úì Yes ‚Üí "Thanks!" ‚Üí GIVE ‚Üí END
        check.connect(0, sayThanks, 0);
        sayThanks.connect(0, give, 0);
        give.connect(0, end1, 0);

        // CHECK ‚úó No ‚Üí "You don't have it!" ‚Üí END
        check.connect(1, sayLiar, 0);
        sayLiar.connect(0, end2, 0);
      },

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // SHOP: Buy something with money
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      shop: () => {
        const start = LiteGraph.createNode("Dialog/Start");
        start.pos = [100, 150];
        graph.add(start);

        const greet = LiteGraph.createNode("Dialog/Say");
        greet.pos = [280, 150];
        greet.properties.text = "Welcome! Potion costs 20 gold.";
        graph.add(greet);

        const choice = LiteGraph.createNode("Dialog/Choice");
        choice.pos = [500, 130];
        choice.properties.c1 = "Buy Potion";
        choice.properties.c2 = "No thanks";
        choice.outputs[0].name = "Buy Potion";
        choice.outputs[1].name = "No thanks";
        graph.add(choice);

        const check = LiteGraph.createNode("Dialog/Check");
        check.pos = [720, 60];
        check.properties.type = "money";
        check.properties.id = "";
        check.properties.amount = 20;
        graph.add(check);

        const bye = LiteGraph.createNode("Dialog/Say");
        bye.pos = [720, 240];
        bye.properties.text = "Come again!";
        graph.add(bye);

        const sold = LiteGraph.createNode("Dialog/Say");
        sold.pos = [940, 30];
        sold.properties.text = "Here you go!";
        graph.add(sold);

        const poor = LiteGraph.createNode("Dialog/Say");
        poor.pos = [940, 150];
        poor.properties.text = "You can't afford that!";
        graph.add(poor);

        const give = LiteGraph.createNode("Dialog/Give");
        give.pos = [1160, 30];
        give.properties.type = "item";
        give.properties.id = "potion";
        give.properties.amount = 1;
        graph.add(give);

        const end1 = LiteGraph.createNode("Dialog/End");
        end1.pos = [1380, 30];
        graph.add(end1);

        const end2 = LiteGraph.createNode("Dialog/End");
        end2.pos = [1160, 150];
        graph.add(end2);

        const end3 = LiteGraph.createNode("Dialog/End");
        end3.pos = [940, 240];
        graph.add(end3);

        start.connect(0, greet, 0);
        greet.connect(0, choice, 0);
        choice.connect(0, check, 0);
        choice.connect(1, bye, 0);
        check.connect(0, sold, 0);
        check.connect(1, poor, 0);
        sold.connect(0, give, 0);
        give.connect(0, end1, 0);
        poor.connect(0, end2, 0);
        bye.connect(0, end3, 0);
      },
    };

    if (templates[name]) {
      templates[name]();
      if (canvas) {
        canvas.ds.offset[0] = -50;
        canvas.ds.offset[1] = -100;
        canvas.ds.scale = 1;
      }
    }
  };
</script>

<style is:global>
  .litemenu-mobile,
  .litemenu,
  .litegraph .litemenu,
  div.litemenu,
  .litecontextmenu,
  .litegraph-dialog {
    z-index: 99999 !important;
    position: fixed !important;
  }

  .litemenu,
  .litemenu-mobile {
    background: #1a1a1a !important;
    color: #eee !important;
    font-family: system-ui, sans-serif !important;
    font-size: 12px !important;
    border: 1px solid #333 !important;
    border-radius: 6px !important;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6) !important;
    padding: 4px 0 !important;
  }

  .litemenu-entry {
    padding: 8px 14px !important;
    border-radius: 4px !important;
    margin: 2px 4px !important;
  }

  .litemenu-entry:hover {
    background: #2a2a2a !important;
    color: #fff !important;
  }
</style>
