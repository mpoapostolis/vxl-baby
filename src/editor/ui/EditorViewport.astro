---
import ScriptEditor from "./ScriptEditor.astro";
---

<main
  class="flex-1 relative flex flex-col gap-0 overflow-hidden bg-[var(--bg-app)]"
>
  <!-- Toolbar -->
  <div
    class="h-10 bg-[var(--bg-header)] border-b border-[var(--border-dark)] flex items-center px-4 justify-between select-none shrink-0 gap-4"
  >
    <!-- Left: Scene Management -->
    <div class="flex items-center gap-2 flex-1">
      <div
        class="flex items-center gap-1 bg-[var(--bg-input)] rounded px-2 py-1 border border-[var(--border-light)] min-w-[160px]"
      >
        <span
          class="text-[10px] text-[var(--text-muted)] font-bold tracking-wider"
          >SCENE</span
        >
        <select
          x-model="currentLevelId"
          @change="loadLevel(currentLevelId)"
          class="bg-transparent text-xs text-[var(--text-main)] outline-none border-none cursor-pointer flex-1"
        >
          <template x-for="level in levelList" :key="level.id">
            <option
              :value="level.id"
              x-text="level.name + (level.isBuiltIn ? '' : ' *')"></option>
          </template>
        </select>
      </div>

      <div
        class="flex items-center rounded overflow-hidden border border-[var(--border-light)] opacity-80 hover:opacity-100 transition-opacity"
      >
        <button
          @click="showNewLevelModal = true"
          class="px-2 py-1 bg-[var(--bg-panel)] hover:bg-[var(--bg-input-hover)] text-[10px] text-[var(--text-main)] border-r border-[var(--border-light)] transition-colors"
          title="Create New Scene"
        >
          <span>Ôºã New</span>
        </button>
        <button
          @click="duplicateLevel(currentLevelId)"
          class="px-2 py-1 bg-[var(--bg-panel)] hover:bg-[var(--bg-input-hover)] text-[10px] text-[var(--text-main)] border-r border-[var(--border-light)] transition-colors"
          title="Duplicate"
        >
          <span>üìã</span>
        </button>
        <button
          @click="deleteLevel(currentLevelId)"
          class="px-2 py-1 bg-[var(--bg-panel)] hover:bg-red-900/50 hover:text-red-200 text-[10px] text-[var(--text-main)] transition-colors"
          :class="isBuiltInLevel(currentLevelId) ? 'opacity-30 cursor-not-allowed' : ''"
          :disabled="isBuiltInLevel(currentLevelId)"
          title="Delete Scene"
        >
          <span>üóëÔ∏è</span>
        </button>
      </div>
    </div>

    <!-- Center: Transform Tools -->
    <div
      class="flex items-center bg-[var(--bg-input)] rounded p-0.5 border border-[var(--border-light)] shadow-sm"
    >
      <button
        @click="setTransformMode('position')"
        class="px-4 py-1 rounded-[2px] text-[10px] font-bold transition-all relative overflow-hidden flex items-center gap-1.5"
        :class="transformMode === 'position' ? 'bg-[#3b82f6] text-white shadow-sm' : 'text-[var(--text-muted)] hover:bg-[var(--bg-input-hover)] hover:text-[var(--text-main)]'"
        title="Move Tool (G)"
      >
        <span class="text-sm">‚ú•</span>
        <span>MOVE</span>
      </button>
      <div class="w-px h-3 bg-[var(--border-dark)] mx-0.5 opacity-50"></div>
      <button
        @click="setTransformMode('rotation')"
        class="px-4 py-1 rounded-[2px] text-[10px] font-bold transition-all relative overflow-hidden flex items-center gap-1.5"
        :class="transformMode === 'rotation' ? 'bg-[#3b82f6] text-white shadow-sm' : 'text-[var(--text-muted)] hover:bg-[var(--bg-input-hover)] hover:text-[var(--text-main)]'"
        title="Rotate Tool (R)"
      >
        <span class="text-sm">‚Üª</span>
        <span>ROTATE</span>
      </button>
      <div class="w-px h-3 bg-[var(--border-dark)] mx-0.5 opacity-50"></div>
      <button
        @click="setTransformMode('scale')"
        class="px-4 py-1 rounded-[2px] text-[10px] font-bold transition-all relative overflow-hidden flex items-center gap-1.5"
        :class="transformMode === 'scale' ? 'bg-[#3b82f6] text-white shadow-sm' : 'text-[var(--text-muted)] hover:bg-[var(--bg-input-hover)] hover:text-[var(--text-main)]'"
        title="Scale Tool (S)"
      >
        <span class="text-sm">‚§¢</span>
        <span>SCALE</span>
      </button>
    </div>

    <!-- Right: File Actions -->
    <div class="flex items-center gap-3 flex-1 justify-end">
      <!-- Save Status Pill -->
      <div
        class="text-[9px] font-bold px-2 py-0.5 rounded-full border flex items-center gap-1.5 transition-colors"
        :class="isDirty ? 'text-amber-400 border-amber-900/50 bg-amber-900/20' : 'text-emerald-400 border-emerald-900/50 bg-emerald-900/20'"
        x-text="isDirty ? '‚óè Unsaved' : '‚óè Saved'"
      >
      </div>

      <div class="h-4 w-px bg-[var(--border-light)]"></div>

      <div class="flex items-center gap-1">
        <button
          @click="saveCurrentLevel"
          class="blender-btn text-xs !py-1"
          :class="isDirty ? '!border-amber-700/50 !bg-amber-900/20 hover:!bg-amber-900/30' : ''"
          title="Save Scene (Cmd+S)"
        >
          <span>üíæ</span>
          <span class="font-bold">Save</span>
        </button>

        <button
          @click="playGame"
          class="blender-btn text-xs !py-1 !text-emerald-400 !border-emerald-700/50 !bg-emerald-900/20 hover:!bg-emerald-900/30"
          title="Play Level"
        >
          <span>‚ñ∂Ô∏è</span>
          <span class="font-bold">Play</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Canvas Container -->
  <div class="flex-1 relative shadow-inner" id="canvas-container">
    <canvas
      id="game-canvas"
      class="block w-full h-full outline-none focus:outline-none"></canvas>

    <!-- Overlay Info (Top Left) -->
    <div
      class="absolute top-3 left-3 pointer-events-none flex flex-col gap-1 select-none"
    >
      <div
        class="text-white/60 text-[10px] font-mono bg-black/40 px-2 py-1 rounded backdrop-blur-sm border border-white/5 shadow-sm"
      >
        PERSPECTIVE
      </div>
    </div>

    <!-- Selection Overlay (Bottom Right) -->
    <div
      class="absolute bottom-3 right-3 pointer-events-none select-none"
      x-show="selectedEntityIdx !== -1"
      x-transition.opacity.duration.200ms
    >
      <div
        class="bg-[var(--bg-panel)]/90 backdrop-blur border border-[var(--border-light)] rounded px-3 py-1.5 shadow-lg flex items-center gap-3"
      >
        <div
          class="w-1.5 h-1.5 rounded-full bg-[var(--accent-primary)] shadow-[0_0_8px_rgba(237,149,43,0.5)]"
        >
        </div>
        <span
          class="text-[10px] text-[var(--text-main)] font-mono font-bold tracking-wide"
          x-text="config.entities[selectedEntityIdx]?.type?.toUpperCase() + ' SELECTED'"
        ></span>
      </div>
    </div>

    <!-- Script Editor Overlay -->
    <ScriptEditor />
  </div>
</main>
